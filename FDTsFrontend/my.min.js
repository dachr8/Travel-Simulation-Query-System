console.log("sync_with_cache = "+!1);$(".date").datetimepicker(),$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e};var socket=new WebSocket("ws://localhost:8145"),sim_time=(new Date).getTime(),part_init=[0,0,0],full_init=!1;document.body.style.backgroundColor="#ffffaa",socket.addEventListener("close",function(e){document.body.style.backgroundColor="#ff7777"}),socket.addEventListener("open",function(e){document.body.style.backgroundColor=""}),socket.addEventListener("message",function(e){var t,n,a=JSON.parse(e.data);if(!full_init&&"get_all_vertex"===a.function){dataset.nodes=a.vertex;var r="";for(var i in a.vertex)r+='<option value="'+a.vertex[i].id+'">'+a.vertex[i].id+"</option>";document.getElementsByName("from")[0].innerHTML=r,document.getElementsByName("to")[0].innerHTML=r,document.getElementsByName("pass_by_vertex_display_name")[0].innerHTML=r,$(".selectpicker").selectpicker("refresh"),part_init[0]=1}if(full_init||"get_all_display_edge"!==a.function||(dataset.edges=(t=a.edges,n=[],t.forEach(function(e){n.push({source:get_node_by_id(e.source),target:get_node_by_id(e.target)})}),n),part_init[1]=1),"sync_time"===a.function&&(sim_time=a.time,part_init[2]=1),"sync_total_transportation_plans"===a.function){for(var i in console.log(a.plans),dataset.markers=[],a.plans){var s={name:(m=a.plans[i]).passenger,display_info:m.display_info,plan:[],plan_index:0};for(var i in m.single_transportation_plans){var o=m.single_transportation_plans[i],d={start_node:dataset.nodes[get_node_by_id(o.from)],end_node:dataset.nodes[get_node_by_id(o.to)],start_time:o.start_time,end_time:o.end_time,display_info:o.display_info};s.plan.push(d)}dataset.markers.push(s)}update_marker_data()}if(full_init&&"submit_passenger_requirement"===a.function){console.log(a);var l=$("#notification"),_=document.getElementById("notification_text");if("error"===a.total_transportation_plan.display_info)return l.css("background-color","rgba(255,75,75,0.6)"),_.innerHTML="Unreachable",l.show(),void l.fadeOut(2e3);l.css("background-color","rgba(75,255,75,0.6)"),_.innerHTML="Ok",l.show(),l.fadeOut(2e3);var m,c=get_marker_by_name((m=a.total_transportation_plan).passenger);if(null===c){s={name:m.passenger,display_info:m.display_info,plan:[],plan_index:0};for(var i in m.single_transportation_plans){o=m.single_transportation_plans[i],d={start_node:dataset.nodes[get_node_by_id(o.from)],end_node:dataset.nodes[get_node_by_id(o.to)],start_time:o.start_time,end_time:o.end_time,display_info:o.display_info};s.plan.push(d)}dataset.markers.push(s)}else{var u=dataset.markers[c];for(var i in u.display_info=m.display_info,m.single_transportation_plans){o=m.single_transportation_plans[i],d={start_node:dataset.nodes[get_node_by_id(o.from)],end_node:dataset.nodes[get_node_by_id(o.to)],start_time:o.start_time,end_time:o.end_time,display_info:o.display_info};u.plan.push(d)}}update_marker_data()}full_init||part_init[0]!==part_init[1]||part_init[1]!==part_init[2]||1!==part_init[0]||(document.getElementById("submit_button").onclick=submit_form,function(){sessionStorage.getItem("sim_time");{sessionStorage.clear()}(force=d3.layout.force().nodes(dataset.nodes).links(dataset.edges).size([w,h]).linkDistance([linkDistance]).charge([-500]).theta(.1).gravity(.05).start()).links([]),setTimeout(function(){force.stop()},1e4);var e=svg.selectAll(".line").data(dataset.edges).enter().append("line").attr("id",function(e,t){return"edge"+t}).attr("marker-end","url(#arrowhead)").style("stroke","#222").style("pointer-events","none"),t=svg.selectAll(".circle").data(dataset.nodes).enter().append("circle").attr({r:30}).style("fill",function(e,t){return color3(t)}).call(force.drag);t.on("click",function(e){e});var n=svg.selectAll(".nodelabel").data(dataset.nodes).enter().append("text").attr({x:function(e){return e.x},y:function(e){return e.y},class:"nodelabel",stroke:"black"}).attr("text-anchor","middle").text(function(e){return e.id}).call(force.drag);n.on("click",function(e){e});var a=svg.selectAll(".edgepath").data(dataset.edges).enter().append("path").attr({d:function(e){return"M "+e.source.x+" "+e.source.y+" L "+e.target.x+" "+e.target.y},class:"edgepath","fill-opacity":0,"stroke-opacity":0,fill:"blue",stroke:"red",id:function(e,t){return"edgepath"+t}}).style("pointer-events","none");force.on("tick",function(){force_timer_started||(force_timer_started=!0,setTimeout(function(){force.stop(),force_timer_started=!1},1e4)),e.attr({x1:function(e){return e.source.x},y1:function(e){return e.source.y},x2:function(e){return e.target.x},y2:function(e){return e.target.y}}),t.attr({cx:function(e){return e.x},cy:function(e){return e.y}}),n.attr("x",function(e){return e.x}).attr("y",function(e){return e.y}),a.attr("d",function(e){var t="M "+e.source.x+" "+e.source.y+" L "+e.target.x+" "+e.target.y;return t}),full_init&&update_marker()});var r=svg.selectAll(".markers").data(dataset.markers);markers=r.enter().append("circle").attr({r:10,class:"markers"}).style("fill",function(e,t){return colors(t)}).on("mouseover",marker_focus),r.exit().remove();var i=svg.selectAll(".marker_text").data(dataset.markers);marker_text=i.enter().append("text").attr({x:function(e){return e.x},y:function(e){return e.y},class:"marker_text",stroke:"black"}).attr("text-anchor","middle").text(function(e){return e.name}).on("mouseover",marker_focus),i.exit().remove(),full_init=!0}())});var svg_container=document.querySelector("#svg_container"),linkDistance=500;document.body.style.height=window.innerHeight+"px",document.querySelector(".container-fluid").style.height=.9*window.innerHeight+"px";var colors=d3.scale.category10(),color2=d3.scale.category20(),color3=function(e){return color2(5+e)};color3();var dataset={nodes:[{id:"City_A"},{id:"City_B"}],edges:[{source:0,target:1}],markers:[]};function get_node_by_id(e){for(var t=0;t<dataset.nodes.length;++t)if(e===dataset.nodes[t].id)return t;return null}function get_marker_by_name(e){for(var t=0;t<dataset.markers.length;++t)if(e===dataset.markers[t].name)return t;return null}socket.addEventListener("open",function(e){["get_all_vertex","get_all_display_edge","sync_time","sync_total_transportation_plans"].forEach(function(e){socket.send(JSON.stringify({function:e}))})});var force,markers,marker_text,svg=d3.select("#svg_container").append("svg").attr({width:"100%",height:"100%"}),w=svg_container.offsetWidth,h=svg_container.offsetHeight,force_timer_started=!1;function update_marker_data(){sessionStorage.setItem("markers",JSON.stringify(dataset.markers)),svg.selectAll(".markers").remove();var e=svg.selectAll(".markers").data(dataset.markers);e.exit().remove(),markers=e.enter().append("circle").attr({r:10,class:"markers"}).style("fill",function(e,t){return colors(t)}).on("mouseover",marker_focus),svg.selectAll(".marker_text").remove();var t=svg.selectAll(".marker_text").data(dataset.markers);t.exit().remove(),marker_text=t.enter().append("text").attr({x:function(e){return e.x},y:function(e){return e.y},class:"marker_text",stroke:"black"}).attr("text-anchor","middle").text(function(e){return e.name}).on("mouseover",marker_focus)}function update_marker(){update_left_detailed_bar(),markers.attr("cx",function(e){if(void 0===e.good&&(e.good=!0),e.good||e.plan_index<0){e.plan_index<0&&(e.plan_index=0);for(var t=!0;e.plan[e.plan_index].start_time>sim_time;)if(--e.plan_index,e.plan_index<0){t=!1;break}for(e.good=t;e.good&&e.plan[e.plan_index].end_time<sim_time;)if(++e.plan_index,e.plan_index>=e.plan.length){e.good=!1;break}}if(e.good){var n=e.plan[e.plan_index];return e.x=n.start_node.x+(sim_time-n.start_time)/(n.end_time-n.start_time)*(n.end_node.x-n.start_node.x),e.x}e.plan_index>=e.plan.length&&(dataset.markers.splice(dataset.markers.indexOf(e),1),update_marker_data())}).attr("cy",function(e){if(e.good){var t=e.plan[e.plan_index];return e.y=t.start_node.y+(sim_time-t.start_time)/(t.end_time-t.start_time)*(t.end_node.y-t.start_node.y),e.y}}),marker_text.attr("x",function(e){return e.x}).attr("y",function(e){return e.y})}var current_time_element=document.getElementById("current_time"),time_d=(new Date).getTime();function submit_form(){var e=$("#form").serializeObject();if(void 0===e.pass_by_vertex_display_name&&(e.pass_by_vertex_display_name=[]),e.pass_by_vertex_display_name instanceof Array||(e.pass_by_vertex_display_name=[e.pass_by_vertex_display_name]),e.function="submit_passenger_requirement",""==e.start_time?e.start_time=parseInt(new Date(sim_time+1e4).getTime()):e.start_time=parseInt(new Date(e.start_time).getTime()),""==e.total_time_limit?e.total_time_limit=0:e.total_time_limit=parseInt(new Date(e.total_time_limit).getTime()),e.start_time<(new Date).getTime(sim_time))console.log("time invalid");else if(0<e.total_time_limit&&e.total_time_limit<(new Date).getTime(sim_time))console.log("time invalid");else if(""!=e.passenger){console.log(e);var t=get_marker_by_name(e.passenger);if(null!==t){for(;1<dataset.markers[t].plan.length-dataset.markers[t].plan_index;)dataset.markers[t].plan.pop();var n=dataset.markers[t].plan[dataset.markers[t].plan_index];n.start_node===n.end_node&&dataset.markers[t].plan.pop()}socket.send(JSON.stringify(e))}else console.log("invalid id")}setInterval(function(){var e=(new Date).getTime();full_init&&update_marker(),sim_time+=3600*(e-time_d),time_d=e;var t=get_marker_by_name($("#form").serializeObject().passenger);if(null!==t){var n=dataset.markers[t];0<=n.plan_index&&(document.getElementsByName("from")[0].value!=n.plan[n.plan_index].end_node.id&&(document.getElementsByName("from")[0].value=n.plan[n.plan_index].end_node.id,$('.selectpicker[name="from"]').selectpicker("refresh")),n.plan[n.plan_index].end_node!==n.plan[n.plan_index].start_node&&$("#datetimepicker1").data("datetimepicker").date(new Date(n.plan[n.plan_index].end_time)))}current_time_element.innerHTML=new Date(sim_time)},1),setInterval(function(){full_init&&socket.send(JSON.stringify({function:"sync_time"})),sessionStorage.setItem("sim_time",sim_time)},1e3);document.querySelector('[name="passenger"]');var focused_mark=null;function marker_focus(e){focused_mark=e,update_left_detailed_bar()}function update_left_detailed_bar(){if(null!=focused_mark){var e=focused_mark;if(document.getElementById("fdt-overlay-passenger").innerHTML=e.name,0<=e.plan_index&&e.plan_index<e.plan.length){var t=e.plan[e.plan_index];document.getElementById("fdt-overlay-from").innerHTML=t.start_node.id,document.getElementById("fdt-overlay-to").innerHTML=t.end_node.id;var n=t.display_info.split(" "),a=n[0],r=n[1];document.getElementById("fdt-overlay-by").innerHTML=a,document.getElementById("fdt-overlay-cost").innerHTML=parseFloat(r),document.getElementById("fdt-overlay-starttime").innerHTML=new Date(t.start_time),document.getElementById("fdt-overlay-endtime").innerHTML=new Date(t.end_time)}var i=e.display_info.split(" ");console.log(i),document.getElementById("fdt-overlay-totalendtime").innerHTML=new Date(parseInt(i[1])),document.getElementById("fdt-overlay-totalcost").innerHTML=parseFloat(i[0])}}